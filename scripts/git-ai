#!/bin/bash
# 0. Check Dependencies
if ! command -v jq &>/dev/null; then
    echo "‚ùå Error: 'jq' is not installed."
    echo "Install it with: sudo dnf install jq (or sudo apt install jq)"
    exit 1
fi
if [ -z "$GROQ_API_KEY" ]; then
    echo "‚ùå Error: GROQ_API_KEY is missing."
    exit 1
fi

# 1. Check for Staged Changes
if git diff --cached --quiet; then
    echo "Error: No staged changes to commit."
    exit 1
fi

# --- NEW: Capture user hint ---
USER_HINT=$1
HINT_SECTION=""
if [ ! -z "$USER_HINT" ]; then
    HINT_SECTION="USER INTENT/CONTEXT: $USER_HINT"
fi
# ------------------------------

# 2. Gather Context
DIFF_STAT=$(git diff --cached --stat)

# Smart diff gathering: reduce context lines based on number of changed files
CHANGED_FILES=$(git diff --cached --name-only | wc -l)

if [ "$CHANGED_FILES" -gt 20 ]; then
    # Many files: use minimal context (U0), skip large files
    DIFF_DETAILED=$(git diff --cached -U0 --diff-filter=d -- . \
        ':(exclude)package-lock.json' \
        ':(exclude)yarn.lock' \
        ':(exclude)*.lock' \
        ':(exclude)*.svg' \
        ':(exclude)*.out' \
        ':(exclude)*.png' \
        ':(exclude)*.jpg' \
        ':(exclude)*.gif' \
        ':(exclude)*.pdf' \
        ':(exclude)dist/*' \
        ':(exclude)build/*' \
        ':(exclude).next/*' | head -c 4000)
elif [ "$CHANGED_FILES" -gt 10 ]; then
    # Medium files: use minimal context (U0)
    DIFF_DETAILED=$(git diff --cached -U0 --diff-filter=d -- . \
        ':(exclude)package-lock.json' \
        ':(exclude)yarn.lock' \
        ':(exclude)*.lock' \
        ':(exclude)*.svg' \
        ':(exclude)*.out' \
        ':(exclude)*.png' \
        ':(exclude)*.jpg' \
        ':(exclude)dist/*' \
        ':(exclude)build/*' | head -c 8000)
else
    # Few files: use standard context (U1)
    DIFF_DETAILED=$(git diff --cached -U1 --diff-filter=d -- . \
        ':(exclude)package-lock.json' \
        ':(exclude)yarn.lock' \
        ':(exclude)*.lock' \
        ':(exclude)*.svg' \
        ':(exclude)*.out' \
        ':(exclude)*.png' \
        ':(exclude)*.jpg' | head -c 12000)
fi

PROJECT_STRUCTURE=$(tree -L 2 --gitignore -I '.git|node_modules|dist|build|coverage' --noreport 2>/dev/null || echo "Structure not available")

# 3. Function to build prompt with diff content
build_prompt() {
    local diff_content="$1"
    echo "Role: Senior Developer.
Task: Write a Conventional Commit message for the diff below.
$HINT_SECTION
CONTEXT:
Project Structure:
$PROJECT_STRUCTURE
Files Changed:
$DIFF_STAT
Rules:
1. Analyze complexity: Atomic = 1 line. Complex = Subject + Bullet points.
2. Format: <type>: <subject>
3. Style: Imperative mood. No markdown blocks.
DIFF:
$diff_content"
}

# Rough token estimator (conservative: 1 token ‚âà 3 chars)
estimate_tokens() {
    local text="$1"
    local char_count=${#text}
    echo $((char_count / 3))
}

# Build prompt
PROMPT=$(build_prompt "$DIFF_DETAILED")
TOKEN_COUNT=$(estimate_tokens "$PROMPT")

# Log token count
if [ "$TOKEN_COUNT" -gt 10000 ]; then
    echo "‚ö†Ô∏è  Prompt large ($TOKEN_COUNT tokens), using reduced diff" >&2
else
    echo "üìä Prompt size: ~$TOKEN_COUNT tokens" >&2
fi

# 4. Run Groq API with a spinner
echo -n "Thinking (Cloud)..."
(while :; do for c in / - \\ \|; do
    echo -ne "\b$c"
    sleep 0.1
done; done) &
SPINNER_PID=$!

JSON_PROMPT=$(echo "$PROMPT" | jq -R -s '.')
RESPONSE=$(curl -s -X POST "https://api.groq.com/openai/v1/chat/completions" \
    -H "Authorization: Bearer $GROQ_API_KEY" \
    -H "Content-Type: application/json" \
    -d "{
        \"model\": \"llama-3.3-70b-versatile\",
        \"messages\": [{\"role\": \"user\", \"content\": $JSON_PROMPT}],
        \"temperature\": 0.1,
        \"max_tokens\": 200
     }")

kill $SPINNER_PID 2>/dev/null
echo -ne "\b \n"

# 5. Extract and Clean
MSG=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
MSG=$(echo "$MSG" | sed -e 's/^```.*//g' -e 's/```$//g' | xargs -0 echo | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')

if [ -z "$MSG" ] || [ "$MSG" == "null" ]; then
    echo "‚ùå Error: Model returned an empty string."
    echo "üìã API Response:"
    echo "$RESPONSE" | jq '.'
    exit 1
fi

# 6. Commit
git commit -e -m "$MSG"
