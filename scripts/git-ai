#!/bin/bash

# 0. Check Dependencies
if ! command -v jq &>/dev/null; then
    echo "❌ Error: 'jq' is not installed."
    echo "Install it with: sudo dnf install jq (or sudo apt install jq)"
    exit 1
fi

if [ -z "$GROQ_API_KEY" ]; then
    echo "❌ Error: GROQ_API_KEY is missing."
    exit 1
fi

# 1. Check for Staged Changes
if git diff --cached --quiet; then
    echo "Error: No staged changes to commit."
    exit 1
fi

# --- NEW: Capture user hint ---
USER_HINT=$1
HINT_SECTION=""
if [ ! -z "$USER_HINT" ]; then
    HINT_SECTION="USER INTENT/CONTEXT: $USER_HINT"
fi
# ------------------------------

# 2. Gather Context
DIFF_STAT=$(git diff --cached --stat)
DIFF_DETAILED=$(git diff --cached -U1 -- . \
    ':(exclude)package-lock.json' \
    ':(exclude)yarn.lock' \
    ':(exclude)*.lock' \
    ':(exclude)*.svg' \
    ':(exclude)*.min.js')

PROJECT_STRUCTURE=$(tree -L 2 --gitignore -I '.git|node_modules|dist|build|coverage' --noreport 2>/dev/null || echo "Structure not available")

# 3. Define the Dynamic Prompt
PROMPT="Role: Senior Developer.
Task: Write a Conventional Commit message for the diff below.

$HINT_SECTION

CONTEXT:
Project Structure:
$PROJECT_STRUCTURE

Files Changed:
$DIFF_STAT

Rules:
1. Analyze complexity: Atomic = 1 line. Complex = Subject + Bullet points.
2. Format: <type>: <subject>
3. Style: Imperative mood. No markdown blocks.

DIFF:
$DIFF_DETAILED"

# 4. Run Groq API with a spinner
echo -n "Thinking (Cloud)..."
(while :; do for c in / - \\ \|; do
    echo -ne "\b$c"
    sleep 0.1
done; done) &
SPINNER_PID=$!

JSON_PROMPT=$(echo "$PROMPT" | jq -R -s '.')

RESPONSE=$(curl -s -X POST "https://api.groq.com/openai/v1/chat/completions" \
    -H "Authorization: Bearer $GROQ_API_KEY" \
    -H "Content-Type: application/json" \
    -d "{
        \"model\": \"llama-3.3-70b-versatile\",
        \"messages\": [{\"role\": \"user\", \"content\": $JSON_PROMPT}],
        \"temperature\": 0.1
     }")

kill $SPINNER_PID
echo -ne "\b \n"

# 5. Extract and Clean
MSG=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
MSG=$(echo "$MSG" | sed -e 's/^```.*//g' -e 's/```$//g' | xargs -0 echo | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')

if [ -z "$MSG" ] || [ "$MSG" == "null" ]; then
    echo "❌ Error: Model returned an empty string."
    exit 1
fi

# 6. Commit
git commit -e -m "$MSG"
